define(["jquery"],function(a){a(document.body).addClass("jschooser");var b={panel:null,submitbutton:null,container:null,listenevents:[],hiddenRadioValue:null,prepare_chooser:function(){if(!this.panel){var b={bodyContent:a("div.createnewquestion div.chooserdialogue").html(),headerContent:a("div.createnewquestion div.choosertitle").html(),width:"540px",draggable:!0,visible:!1,zindex:100,modal:!0,shim:!0,closeButtonTitle:"Close",focusOnPreviousTargetAfterHide:!0,render:!1,extraClasses:this._getClassNames()};this.panel=new M.core.dialogue(b),this.panel.hide(),this.panel.render(),this.container=this.panel.get("boundingBox").one(".choosercontainer"),this.options=this.container.all(".option input[type=radio]"),this.hiddenRadioValue=Y.Node.create('<input type="hidden" value="" />'),this.container.one("form").appendChild(this.hiddenRadioValue),this.panel.get("boundingBox").addClass("chooserdialogue")}},display_chooserdialogue:function(b){this.prepare_chooser(),b.preventDefault();var c=this.panel.get("boundingBox"),d=this.container.one(".alloptions"),e=a(window).on("resize",function(){this.center_dialogue(d)},this);this.listenevents.push(e),e=this.container.on("click",this.check_options,this),this.listenevents.push(e),e=this.container.on("key_up",this.check_options,this),this.listenevents.push(e),e=this.container.on("dblclick",function(b){if(b.target.ancestor("div.option")){this.check_options(),this.submitbutton.setAttribute("disabled","disabled"),this.options.setAttribute("disabled","disabled"),this.cancel_listenevents(),b.preventDefault();var c=a("<input>").attr("type","hidden").attr("name","qtype").val(a("input[name=qtype]:checked").val());a("#blockeditingform").append(a(c)),a("#blockeditingform").submit()}},this),this.listenevents.push(e),this.container.one("form").on("submit",function(a){this.submitbutton.setAttribute("disabled","disabled"),this.options.setAttribute("disabled","disabled"),this.cancel_listenevents(),a.preventDefault()},this),e=this.container.one(".addcancel").on("click",this.cancel_popup,this),this.listenevents.push(e),e=c.one("button.closebutton").on("click",this.cancel_popup,this),this.listenevents.push(e),e=a(document).on("keydown",this.handle_key_press,this),this.listenevents.push(e),this.submitbutton=this.container.one(".submitbutton"),this.submitbutton.on("click",function(b){b.preventDefault();var c=a("<input>").attr("type","hidden").attr("name","qtype").val(a("input[name=qtype]:checked").val());a("#blockeditingform").append(a(c)),a("#blockeditingform").submit()},this),this.submitbutton.set("disabled","true"),this.options.removeAttribute("disabled"),this.panel.show(b),this.center_dialogue(d),this.container.one(".option input[type=radio]").focus(),this.check_options()},cancel_listenevents:function(){for(var a;this.listenevents.length;)a=this.listenevents.shift(),a.detach()},center_dialogue:function(a){var b,c,d=this.panel.get("boundingBox"),e=d.get("winHeight");if(!this.panel.shouldResizeFullscreen()){b=660,b>=e&&(b=300>=e?300:e),b>300?this.panel.lockScroll&&!this.panel.lockScroll.isActive()&&this.panel.lockScroll.enableScrollLock(!0):this.panel.lockScroll&&this.panel.lockScroll.isActive()&&this.panel.lockScroll.disableScrollLock(),c=b,b-=110,a.setStyle("maxHeight",b+"px");var f=d.getStyle("height");f=f.match(/.*px$/)?f.replace(/px$/,""):c,400>f&&(f=400,a.setStyle("height",f+"px")),this.panel.centerDialogue()}},handle_key_press:function(a){27===a.keyCode&&this.cancel_popup(a)},cancel_popup:function(a){a.preventDefault(),this.hide()},hide:function(){this.cancel_listenevents(),this.container.detachAll(),this.panel.hide()},check_options:function(){this.options.each(function(a){var b=a.get("parentNode").get("parentNode");a.get("checked")?(b.addClass("selected"),this.option_selected(a),this.submitbutton.removeAttribute("disabled"),a.focus()):b.removeClass("selected")},this)},option_selected:function(a){this.hiddenRadioValue.setAttrs({value:a.get("value"),name:a.get("name")})},_getClassNames:function(a){var b="chooserdialogue-"+this.name,c=[];if(c.push(b.toLowerCase()),a){var d;for(d in a)c.push((b+"-"+d).toLowerCase())}return c}};return{init:function(){a(".addquestion").click(function(a){b.display_chooserdialogue(a)})}}});