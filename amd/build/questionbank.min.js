define(["jquery","core/ajax"],function(a,b){a(document.body).addClass("jschooser");var c={panel:null,addButton:null,loading:null,prepare_chooser:function(b,c,d){this.panel=a("#"+b),this.addButton=a("#"+c),this.loading=a("#"+d),a(this.panel).find(".modal-body").html(this.loading)},init_question_bank_modal:function(a,b,c){this.prepare_chooser(a,b,c),this.load()},get_href_param:function(a,b){for(var c=a.split("?")[1],d=c.split("&"),e=0;e<d.length;e++){var f=d[e].split("=");if(f[0]==b)return f[1]}return null},questionbank_loaded:function(b){a(this.panel).find(".modal-body").html(b),a(this.panel).find(".modulespecificbuttonscontainer").html(""),a(this.panel).find(".tag-condition-container").html(""),a(".addfromquestionbank").click(function(b){b.preventDefault();var c=a("<input>").attr("type","hidden").attr("name","addfromquestionbank").val(a(this).data("id"));a("#blockeditingform").append(a(c)),a("#blockeditingform").submit()}),a(this.addButton).click(function(b){b.preventDefault();for(var c=a('input:checkbox:checked[name^="q"]'),d=0;d<c.length;d++){var e=a(c[d]).attr("name"),f=a("<input>").attr("type","hidden").attr("name",e).val("1");a("#blockeditingform").append(a(f))}var g=a("<input>").attr("type","hidden").attr("name","add").val("1");a("#blockeditingform").append(a(g)),a("#blockeditingform").submit()}),a(".questionname").click(this.link_clicked),a(".questionbankcontent").find("a").click(a.proxy(this.link_clicked,this)),a("#id_selectacategory").change(a.proxy(this.category_changed,this))},category_changed:function(a){a.preventDefault(),this.load()},link_clicked:function(a){a.preventDefault();var b=this.get_href_param(a.target.href,"qpage"),c=this.get_href_param(a.target.href,"qperpage"),d=this.get_href_param(a.target.href,"qbs1");null===b&&null===c&&null===d||this.load(b,c,d)},load:function(c,d,e){var f={};f.cmid=a(".questionbank").data("cmid"),f.bid=a(".questionbank").data("bid"),c&&(f.page=c),d&&(f.qperpage=d),e&&(f.qbs1=e),f.category=a("#id_selectacategory").val();var g=b.call([{methodname:"mod_ddtaquiz_get_questionbank",args:f}]);g[0].done(a.proxy(this.questionbank_loaded,this)).fail(a.proxy(this.questionbank_load_failed,this))},questionbank_load_failed:function(){a(this.panel).find(".modal-body").html("Error fetching from question bank")}};return{init:function(a,b,d){c.init_question_bank_modal(a,b,d)}}});