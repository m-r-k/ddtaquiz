define(["jquery","core/ajax"],function(a,b){a(document.body).addClass("jschooser");var c={panel:null,loadingDiv:"",prepare_chooser:function(){if(!this.panel){var b={headerContent:a("div.questionbankloadingcontainer").data("title"),bodyContent:a("div.questionbankloading").parent().html(),draggable:!0,modal:!0,centered:!0,width:null,visible:!1,postmethod:"form",footerContent:null,extraClasses:["mod_ddtaquiz_qbank_dialogue"]};this.panel=new M.core.dialogue(b),this.panel.hide(),this.panel.render(),this.loadingDiv=this.panel.bodyNode.getHTML()}},display_chooserdialogue:function(b){this.prepare_chooser(),b.preventDefault(),this.panel.bodyNode.setHTML(a("div.questionbankloading").parent().html()),this.panel.show(),this.load()},get_href_param:function(a,b){for(var c=a.split("?")[1],d=c.split("&"),e=0;e<d.length;e++){var f=d[e].split("=");if(f[0]==b)return f[1]}return null},questionbank_loaded:function(b){this.panel.bodyNode.setHTML(b),this.panel.centerDialogue(),a(".addfromquestionbank").click(function(b){b.preventDefault();var c=a("<input>").attr("type","hidden").attr("name","addfromquestionbank").val(a(this).data("id"));a("#blockeditingform").append(a(c)),a("#blockeditingform").submit()}),a("#addselected").click(function(b){b.preventDefault();for(var c=a('input:checkbox:checked[name^="q"]'),d=0;d<c.length;d++){var e=a(c[d]).attr("name"),f=a("<input>").attr("type","hidden").attr("name",e).val("1");a("#blockeditingform").append(a(f))}var g=a("<input>").attr("type","hidden").attr("name","add").val("1");a("#blockeditingform").append(a(g)),a("#blockeditingform").submit()}),a(".questionname").click(this.link_clicked),a(".questionbankcontent").find("a").click(a.proxy(this.link_clicked,this)),a("#id_selectacategory").change(a.proxy(this.category_changed,this)),this.panel.fire("widget:contentUpdate"),this.panel.get("visible")&&(this.panel.hide(),this.panel.show())},category_changed:function(a){a.preventDefault(),this.load()},link_clicked:function(a){a.preventDefault();var b=this.get_href_param(a.target.href,"qpage"),c=this.get_href_param(a.target.href,"qperpage"),d=this.get_href_param(a.target.href,"qbs1");null===b&&null===c&&null===d||this.load(b,c,d)},load:function(c,d,e){var f={};f.cmid=a(".questionbank").data("cmid"),f.bid=a(".questionbank").data("bid"),c&&(f.page=c),d&&(f.qperpage=d),e&&(f.qbs1=e),f.category=a("#id_selectacategory").val(),this.panel.bodyNode.setHTML(a("div.questionbankloading").parent().html());var g=b.call([{methodname:"mod_ddtaquiz_get_questionbank",args:f}]);g[0].done(a.proxy(this.questionbank_loaded,this)).fail(a.proxy(this.questionbank_load_failed,this))},questionbank_load_failed:function(){this.panel.bodyNode.setHTML("Error fetching from question bank")}};return{init:function(){a(".questionbank").click(function(a){c.display_chooserdialogue(a)})}}});